<!DOCTYPE html>
<meta charset="utf-8">
<html>

<head>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <script src="https://d3js.org/d3-dispatch.v1.min.js"></script>
  <script src="https://d3js.org/d3-quadtree.v1.min.js"></script>
  <script src="https://d3js.org/d3-timer.v1.min.js"></script>
  <script src="https://d3js.org/d3-force.v2.min.js"></script>
  <link rel="stylesheet" href="style/style.css">
  </style>
</head>

<body>
  <svg> </svg>
  <div id="bottom-bar">
    <ul id="years"></ul>
  </div>
  <script type="text/javascript">
    var json = (function() {
      var json = null;
      $.ajax({
        'async': false,
        'global': false,
        'url': 'assets/result100year2.json',
        'dataType': "json",
        'success': function(data) {
          json = data;
        }
      });
      return json;
    })();
    var nodes = []
    var links = []
    var years = $('ul#years')
    $.each(json['years'], function(i) {
      var li = $('<li/>')
        .addClass('ui-menu-item')
        .attr('role', 'menuitem')
        .appendTo(years)
        .click(function() {
          updateDataByYear(json['years'][i])
          updateSimulation()
        });
      var aaa = $('<a/>')
        .addClass('ui-all')
        .text(json['years'][i])
        .appendTo(li);
    });
    nodes = flattenNodes(json['nodes']["1969"])
    links = json['links']["1969"]
    //D3 stuff goes here
    const width = window.innerWidth
    const height = window.innerHeight
    const radius = 10
    const svg = d3.select('svg')
      .attr('width', width)
      .attr('height', height)

    const linkGroup = svg.append("g").attr("class", "links")
    const nodeGroup = svg.append("g").attr("class", "nodes")
    const textGroup = svg.append("g").attr("class", "texts")

    var linkElements,
      nodeElements,
      textElements

    var linkForce = d3
      .forceLink()
      .id(function (link) { return link.id })
      .strength(function (link) { return link.strength })

    const simulation = d3.forceSimulation()
      .force('link', linkForce)
      .force('charge', d3.forceManyBody().strength(-70))
      .force('gravity',d3.forceManyBody(0.05))
      .force('center', d3.forceCenter(width / 2, height / 2))

    const dragDrop = d3.drag()
      .on('start', node => {
        node.fx = node.x
        node.fy = node.y
      })
      .on('drag', node => {
        simulation.alphaTarget(0.7).restart()
        node.fx = d3.event.x
        node.fy = d3.event.y
      })
      .on('end', node => {
        if (!d3.event.active) {
          simulation.alphaTarget(0)
        }
        node.fx = null
        node.fy = null
      })
    simulation.force('link', d3.forceLink()
      .id(link => link.id)
      .strength(link => Math.pow(link.strength,2)/1000))
      .force('gravity',d3.forceManyBody(30))

    function getNodeColor(node) {
      return 'gray'
    }


    //RENDER ORDER

    function onMenuClick(year) {}

    function updateDataByNode(nodeId) {

    }

    function updateDataByYear(year) {

      console.log("AY")
      var newNodes = flattenNodes(json['nodes'][year])
      const diff = {
        removed: nodes.filter(node => newNodes.indexOf(node) === -1),
        added: newNodes.filter(node => nodes.indexOf(node) === -1)
      }

      diff.removed.forEach(node => nodes.splice(nodes.indexOf(node), 1))
      diff.added.forEach(node => nodes.push(node))

      links = json['links'][year] != null? json['links'][year] : []
    }

    function updateGraph() {
      // links
      linkElements = linkGroup.selectAll('line')
        .data(links, function (link) {
          return link.target.id + link.source.id
        })
      linkElements.exit().remove()
      var linkEnter = linkElements
        .enter().append('line')
        .attr('stroke-width', 2)
        .attr('stroke', 'rgba(50, 50, 50,0.2)')
      linkElements = linkEnter.merge(linkElements)

      // nodes
      nodeElements = nodeGroup.selectAll('circle')
        .data(nodes, function(node) { return node.id })

      nodeElements.exit().remove()

      var nodeEnter = nodeElements
        .enter()
        .append('circle')
        .attr('r', radius -.75)
        .attr('fill', 'gray')
        .call(dragDrop)
      // we link the selectNode method here
      // to update the graph on every click
      //.on('click', selectNode)

      nodeElements = nodeEnter.merge(nodeElements)

      // texts
      textElements = textGroup.selectAll('text')
        .data(nodes, function(node) { return node.id })

      textElements.exit().remove()

      var textEnter = textElements
        .enter()
        .append('text')
        .text(function(node) { return node.title })
        .attr('font-size', 15)
        .attr('dx', 15)
        .attr('dy', 4);

      textElements = textEnter.merge(textElements)
    }

    function flattenNodes(nodesToFlatten) {
      newNodes = []
      for (var key in nodesToFlatten) {
        nodesToFlatten[key].id = key
        newNodes.push(nodesToFlatten[key])
      }
      return newNodes;
    }

    function updateSimulation() {
      updateGraph()
      simulation.nodes(nodes).on('tick', () => {
        nodeElements
          .attr('cx', function(node) { return node.x = Math.max(radius, Math.min(width - radius, node.x)) })
          .attr('cy', function(node) { return node.y = Math.max(radius, Math.min(height - radius - 149, node.y)) })
        textElements
          .attr('x', function(node) { return node.x})
          .attr('y', function(node) { return node.y})
        linkElements
          .attr('x1', function(link) { return link.source.x })
          .attr('y1', function(link) { return link.source.y })
          .attr('x2', function(link) { return link.target.x })
          .attr('y2', function(link) { return link.target.y })
      })
      simulation.force('link').links(links)
      simulation.alphaTarget(0.7).restart()
    }
    updateSimulation()
  </script>

</body>

</html>
